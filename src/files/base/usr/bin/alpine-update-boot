#!/bin/sh -e

cmdline="$1"
entry="$2"

# Get cmdline from config if not provided
[ -z "${cmdline}" ] && cmdline=$(alpine-get-config cmdline)

next_entry() {
  entry=$(alpine-get-cmdline alpine.slot)
  case "${entry}" in
    A) echo "2" ;;
    B) echo "1" ;;
    *) echo "Invalid slot: ${entry}" >&2; exit 1 ;;
  esac
}

parse_entry() {
  case "$1" in
    A) echo "1";;
    B) echo "2";;
    *) echo "Invalid slot: $1" >&2; exit 1;;
  esac
}

# Get the next entry if not provided
[ -z "${entry}" ] && entry=$(next_entry) || entry=$(parse_entry "${entry}")

# Ensure /boot is mounted and get the device
dev=$(findmnt -n -o SOURCE /boot | sed 's/p\?[0-9]*$//')
if [ -z "${dev}" ]; then
  echo "/boot is not mounted"
  exit 1
fi

# Update Limine Bootloader files
mkdir -p /boot/EFI/BOOT/ /boot/limine
cp /usr/share/limine/limine-bios.sys /boot/limine
cp /usr/share/limine/BOOTX64.EFI /boot/EFI/BOOT/
limine bios-install "${dev}"

# Generate Limine configuration
cat << EOF > /boot/limine/limine.conf
\${cmdline}="${cmdline}"
default_entry: "${entry}"
timeout: 2

/Alpine (A)
  protocol: linux
  path: boot():/alpine/A/vmlinuz
  cmdline: \${cmdline} alpine.slot=A
  module_path: boot():/alpine/A/initramfs

/Alpine (B)
  protocol: linux
  path: boot():/alpine/B/vmlinuz
  cmdline: \${cmdline} alpine.slot=B
  module_path: boot():/alpine/B/initramfs
EOF