#!/bin/sh -e
slot="$1"
image="$2"

next_entry() {
  entry=$(alpine-get-cmdline alpine.slot)
  case "${entry}" in
    A) echo "2" ;;
    B) echo "1" ;;
    *) echo "Invalid slot: ${entry}" >&2; exit 1 ;;
  esac
}

[ -z "${image}" ] && image=$(alpine-get-config image)
[ -z "${slot}" ] && slot=$(next_entry)

if ! mountpoint -q /boot; then
  echo "/boot is not mounted"
  exit 1
fi

arch=$(uname -m | grep -q x86_64 && echo amd64 || echo arm64)
digest=$(oras manifest fetch --platform linux/$arch --registry-config="" --descriptor "$image" | yq -r ".digest" )

mkdir -p /boot/alpine/$slot
if [ -f /boot/alpine/$slot/.digest ]; then
  if [ "$digest" = "$(cat /boot/alpine/$slot/.digest)" ]; then
    echo "Alpine image is already up to date in slot $slot."
    exit 0
  fi
fi

oras pull --platform linux/$arch --registry-config="" -o /boot/alpine/$slot/ $image 
echo "$digest" > /boot/alpine/$slot/.digest