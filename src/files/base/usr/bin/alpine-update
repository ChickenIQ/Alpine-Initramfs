#!/bin/sh -e

# Get an option from the configuration file
get_config() { /usr/libexec/alpine-get-config "$1"; }

# Get a parameter from the kernel command line
get_cmdline() { /usr/libexec/alpine-get-cmdline "$1"; }

get_slot_name() { [ "$1" = "1" ] && echo "A" || echo "B"; }

# Get the next slot number
get_next_slot() {
  [ -n "$ALPINE_SLOT" ] && { echo "$ALPINE_SLOT"; return; }
  [ "$1" = "1" ] && echo "2" || echo "1"
}

# Get the currently booted slot from kernel command line
get_booted_slot() {
  [ -n "$ALPINE_SLOT" ] && { echo "$ALPINE_SLOT"; return; }
  local slot=$(get_cmdline "alpine.slot")
  case "$slot" in
    A|a) echo "1" ;;
    B|b) echo "2" ;;
    *) echo "Invalid slot: $slot" >&2; exit 1 ;;
  esac
}

# Get the current default boot slot from limine configuration
get_config_slot() {
  [ -n "$ALPINE_SLOT" ] && { echo "$ALPINE_SLOT"; return; }
  local slot=""
  if [ -f /boot/limine/limine.conf ]; then
    slot=$(sed -n 's/^default_entry: *"\?\([0-9]\+\)"\?.*/\1/p' /boot/limine/limine.conf)
  fi

  if [ -z "${slot}" ]; then
    slot="1"
  fi

  echo "$slot"
}

# Check if a slot already has the specified digest
compare_digest() {
  local slot="$1"
  local digest="$2"
  
  mkdir -p /boot/alpine/$slot
  if [ -f /boot/alpine/$slot/.digest ]; then
    if [ "$digest" = "$(cat /boot/alpine/$slot/.digest)" ]; then
      echo "Image already up to date in slot $slot."
      return 0
    fi
  fi
  return 1
}

# Update the Alpine image in the specified slot if it's outdated
update_image() {
  local slot="$1"
  local image="$2"

  local current_slot=$(get_slot_name "$slot")
  local next_slot=$(get_slot_name "$(get_next_slot "$slot")")
  
  local arch=$(uname -m | grep -q x86_64 && echo amd64 || echo arm64)
  local digest=$(oras manifest fetch --platform linux/$arch --registry-config="" --descriptor "$image" | yq -r ".digest" )

  # Check if current slot already has this digest
  if compare_digest "$current_slot" "$digest"; then
    return 1
  fi

  # Check if next slot already has this digest
  if compare_digest "$next_slot" "$digest"; then
    return 1
  fi

  echo "Updating Alpine image in slot $next_slot..."
  oras pull --platform linux/$arch --registry-config="" -o /boot/alpine/$next_slot/ $image 
  echo "$digest" > /boot/alpine/$next_slot/.digest
  return 0
}

# Update Limine bootloader configuration
update_boot() {
  local dev="$1"
  local entry="$2"
  local cmdline="$3"
  local install="$4"

  # Update Limine Bootloader files
  if [ "$install" = "true" ]; then
    mkdir -p /boot/EFI/BOOT/ /boot/limine
    cp /usr/share/limine/limine-bios.sys /boot/limine
    cp /usr/share/limine/BOOTX64.EFI /boot/EFI/BOOT/
    limine bios-install "${dev}" > /dev/null
  fi

  # Generate Limine configuration
  echo "Updating Limine configuration (Slot: $entry)..."
  cat <<- EOF > /boot/limine/limine.conf
  \${cmdline}="${cmdline}"
  default_entry: ${entry}
  timeout: 2

  /Alpine (A)
    protocol: linux
    path: boot():/alpine/A/vmlinuz
    cmdline: \${cmdline} alpine.slot=A
    module_path: boot():/alpine/A/initramfs

  /Alpine (B)
    protocol: linux
    path: boot():/alpine/B/vmlinuz
    cmdline: \${cmdline} alpine.slot=B
    module_path: boot():/alpine/B/initramfs
EOF
}

# Ensure /boot is mounted and get the device
dev=$(findmnt -n -o SOURCE /boot | sed 's/p\?[0-9]*$//')
if [ -z "${dev}" ]; then
  echo "/boot is not mounted"
  exit 1
fi

image=${ALPINE_IMAGE:-$(get_config "image")}
if [ -z "$image" ]; then
  echo "No image specified in /boot/alpine/config.yaml"
  exit 1
fi


# Update image and switch slots if the image changed, else use the one from the limine config
current_slot="$(get_booted_slot)"
if update_image "$current_slot" "$image"; then
  boot_slot=$(get_next_slot "$current_slot")
else
  boot_slot=$(get_config_slot)
fi

# Update Bootloader
cmdline="${ALPINE_CMDLINE:-$(get_config "cmdline")}"
install_bootloader="${ALPINE_INSTALL_BOOTLOADER:-false}"

update_boot "$dev" "$boot_slot" "$cmdline" "$install_bootloader"