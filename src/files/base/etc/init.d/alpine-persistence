#!/sbin/openrc-run

description="Mount optional Alpine boot and data partitions"

depend() {
  after dev mdev hwdrivers
}

start() {
  ebegin "Mounting Persistence Partitions"
  mkdir -p /boot /data

  # Attempt to mount boot
  einfo "Checking for alpine-boot partition..."
  if [ -b "/dev/disk/by-partlabel/alpine-boot" ]; then
    einfo "Found alpine-boot partition."
    mount -o defaults,noatime /dev/disk/by-partlabel/alpine-boot /boot
    einfo "Mounted alpine-boot on /boot"
  fi

  # Attempt to mount data
  einfo "Checking for alpine-data partition..."
  if [ -b "/dev/disk/by-partlabel/alpine-data" ]; then
    einfo "Found alpine-data partition."
    mount -o defaults,noatime /dev/disk/by-partlabel/alpine-data /data
    einfo "Mounted alpine-data on /data"
  fi
  
  eend 0
}

stop() {
  ebegin "Unmounting Persistence Partitions"
  umount /data 2>/dev/null
  umount /boot 2>/dev/null
  eend 0
}