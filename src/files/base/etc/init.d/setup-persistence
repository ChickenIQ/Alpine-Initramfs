#!/sbin/openrc-run

description="Mount optional Alpine boot and data partitions"

depend() {
  need dev
  after mdev
  before localmount
}

start() {
  ebegin "Mounting Persistence Partitions"
  
  local boot_mounted=false
  local data_mounted=false

  # Attempt to mount boot
  if [ -e "/dev/disk/by-partlabel/alpine-boot" ]; then
    [ ! -d "/boot" ] && mkdir -p /boot  
    if mount -o defaults,noatime /dev/disk/by-partlabel/alpine-boot /boot; then
      einfo "Mounted alpine-boot on /boot"
      boot_mounted=true
    else
      eerror "Failed to mount alpine-boot"
    fi
  fi

  # Attempt to mount data
  if [ -e "/dev/disk/by-partlabel/alpine-data" ]; then
    [ ! -d "/data" ] && mkdir -p /data
    if mount -o defaults,noatime /dev/disk/by-partlabel/alpine-data /data; then
      einfo "Mounted alpine-data on /data"
      data_mounted=true
    else
      eerror "Failed to mount alpine-data"
    fi
  fi

  # Only setup persistence if both partitions are mounted
  if [ "$boot_mounted" = true ] && [ "$data_mounted" = true ]; then
    einfo "Setting up persistent files and directories..."
    
    persistent_files=$(alpine-get-config persitence.files)
    persistent_dirs=$(alpine-get-config persitence.dirs)
    
    for file in $persistent_files; do
      alpine-persist-path file "$file"
    done

    for dir in $persistent_dirs; do
       alpine-persist-path dir "$dir"
    done
  else
    ewarn "Skipping persistence: One or more partitions is not mounted."
  fi

  eend 0
}

stop() {
  ebegin "Unmounting Persistence Partitions"
  umount /data 2>/dev/null
  umount /boot 2>/dev/null
  eend 0
}