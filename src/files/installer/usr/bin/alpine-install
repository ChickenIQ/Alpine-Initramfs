#!/bin/sh -e

get_cmdline() { /usr/libexec/alpine-get-cmdline "$1"; }

cmdline=$(get_cmdline alpine.cmdline)
image=$(get_cmdline alpine.image)
dev=$(get_cmdline alpine.disk)

[ -z "${image}" ] && echo "alpine.image kernel parameter is required." && exit 1
[ -z "${dev}" ] && echo "alpine.disk kernel parameter is required." && exit 1
[ ! -b "${dev}" ] && echo "Device ${dev} does not exist." && exit 1

echo "Waiting for DNS and Internet connectivity"
count=0
while ! wget -q --spider -T 2 https://ghcr.io 2>/dev/null; do
  if [ $count -ge 300 ]; then
    echo "Network/DNS timed out"
    exit 1
  fi
  count=$((count + 1)) 
  sleep 1
done

echo "Partitioning Disk: ${dev}"
sgdisk -Z \
  -n 1::+1M -t 1:ef02 -c 1:"alpine-bios" \
  -n 2::+5G -t 2:ef00 -c 2:"alpine-boot" \
  -n 3::    -t 3:8300 -c 3:"alpine-data" \
  "${dev}"

# Handle nvme vs sd device naming
part="${dev}"
[[ "$dev" == *"nvme"* ]] && part="${dev}p"

mkfs.fat -F 32 -I "${part}2"
mkfs.ext4 -F "${part}3"

mkdir -p /boot
mount "${part}2" /boot

# Write Default config.yaml
mkdir -p /boot/alpine
cat << EOF > /boot/alpine/config.yaml
image: "${image}"
cmdline: "${cmdline}"

persistence:
  files: []
  dirs: []
EOF

# Install Alpine Image
export ALPINE_SLOT="1" 
export ALPINE_IMAGE="${image}"
export ALPINE_CMDLINE="${cmdline}"
export ALPINE_INSTALL_BOOTLOADER="true"

echo "Installing Alpine Image: ${image}"
alpine-update

echo "Installation complete. Rebooting..."
sleep 2
reboot
